# ビジネスルール
記載フォーマット
```
- ビジネスルール名
  - 識別子: [英語で記載、実装するクラス名と同じにする] ※エンティティに関するビジネスルール（エンティティの普遍条件や振る舞いに入れ込むのには違和感があるルール）については~EntitySpecとし、ユースケース（アプリケーション）に関するビジネスルールの場合は~AppSpecとすること
  - 目的/背景
    - [箇条書き]
  - 条件
    - [条件(ルール内容)を箇条書き]
  - 結果(アクション)
    - [箇条書き]
```

---

## AIタスク管理

- AIタスク削除時のワークフローキャンセル
  - 識別子: AiTaskCancellationAppSpec
  - 目的/背景
    - レビュー対象・レビュースペース・プロジェクト削除時に、実行中のAIタスク（ワークフロー）を適切にキャンセルする必要がある
    - キャンセル処理中は新規タスクのデキューをブロックし、一貫性を保つ
  - 条件
    - AIタスクがPROCESSING状態であること
    - 削除対象（レビュー対象・レビュースペース・プロジェクト）に紐づくタスクであること
  - 結果(アクション)
    - ワークフロー実行レジストリからワークフロー実行インスタンスを取得する
    - ワークフローのキャンセルを試みる（run.cancel()）
    - キャンセル中フラグを設定し、新規タスクのデキューをブロックする
    - キャンセル完了後、フラグをクリアする
    - キャンセル失敗時は警告ログを記録し、削除処理は続行する

- AIタスクキャンセル中のデキューブロック
  - 識別子: AiTaskDequeueBlockingAppSpec
  - 目的/背景
    - ワークフローキャンセル処理中に新しいタスクがデキューされると、データ不整合が発生する可能性がある
    - キャンセル処理の一貫性を保証するため、キャンセル中は新規タスクのデキューを一時停止する
  - 条件
    - ワークフロー実行レジストリのキャンセル中フラグがtrueであること
  - 結果(アクション)
    - AiTaskWorkerはデキュー処理をスキップし、ポーリング間隔まで待機する
    - キャンセル完了後（フラグがfalse）に通常のデキュー処理を再開する

---

## リソースクリーンアップ

- レビュー対象削除時のキャッシュクリーンアップ
  - 識別子: ReviewTargetCacheCleanupAppSpec
  - 目的/背景
    - レビュー対象を削除する際、ファイルシステム上のキャッシュファイルも削除する必要がある
    - DBのCASCADE削除はDB内のレコードのみを削除し、ファイルシステムは対象外
  - 条件
    - レビュー対象が削除されること
  - 結果(アクション)
    - ReviewCacheHelper.deleteCacheDirectory(reviewTargetId)を呼び出してキャッシュディレクトリを削除する
    - AIタスクが存在する場合、TaskFileHelper.deleteTaskFiles(taskId)を呼び出してタスクファイルを削除する

- カスケード削除時のリソースクリーンアップ
  - 識別子: CascadeResourceCleanupAppSpec
  - 目的/背景
    - プロジェクトまたはレビュースペース削除時、配下の全リソースをクリーンアップする必要がある
    - DB上のCASCADE削除に加え、ファイルシステム上のキャッシュとAIタスクも適切に処理する
  - 条件
    - プロジェクトまたはレビュースペースが削除されること
  - 結果(アクション)
    - 配下の全レビュースペース（プロジェクト削除時）を取得する
    - 各レビュースペース内の全レビュー対象を取得する
    - 各レビュー対象に対して:
      - AIタスクが存在すればキャンセル・削除する
      - キャッシュディレクトリを削除する
    - チェックリスト生成タスクが存在すればキャンセル・削除する